<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Afiq — S3 Image Uploader</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#0f172a; color:#e2e8f0; display:grid; place-items:center; min-height:100vh; }
    .card { width:min(720px,92vw); background:#111827; border:1px solid #1f2937; border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h2 { margin:0 0 8px; }
    .muted { color:#9ca3af; font-size:13px; }
    .btn { padding:10px 16px; border-radius:10px; background:#2563eb; color:#fff; border:0; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    progress { width:100%; height:12px; margin-top:10px; }
    .thumb { margin-top:14px; max-width:100%; border-radius:10px; border:1px solid #1f2937; display:none; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Upload image to S3</h2>
    <p class="muted">Images only, max 10 MB. Target: <code>uploaded/</code></p>

    <input id="file" type="file" accept="image/*" />
    <button id="go" class="btn">Upload</button>

    <progress id="bar" value="0" max="100"></progress>
    <div class="muted" id="status">Idle</div>

    <img id="preview" class="thumb" alt="Preview" />
    <p class="muted">Object key: <code id="key">—</code></p>
  </div>

<script>
const API = "https://2upze5woa9.execute-api.ap-southeast-1.amazonaws.com/presign";

const fileEl = document.getElementById('file');
const goBtn  = document.getElementById('go');
const bar    = document.getElementById('bar');
const status = document.getElementById('status');
const keyLbl = document.getElementById('key');
const preview= document.getElementById('preview');

goBtn.onclick = async () => {
  const f = fileEl.files[0];
  if (!f) return alert('Choose a file first');
  if (!f.type.startsWith('image/')) return alert('Images only');
  if (f.size > 10 * 1024 * 1024) return alert('Max 10 MB');

  // show preview
  const reader = new FileReader();
  reader.onload = () => { preview.src = reader.result; preview.style.display = 'block'; };
  reader.readAsDataURL(f);

  try {
    status.textContent = 'Requesting URL…';
    const r = await fetch(API, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ filename: f.name, contentType: f.type })
    });
    if (!r.ok) throw new Error('Presign failed');
    const { url, key } = await r.json();
    keyLbl.textContent = key;

    status.textContent = 'Uploading…';
    bar.value = 0;

    await putWithProgress(url, f, f.type);

    status.textContent = 'Done ✅';
    bar.value = 100;
  } catch (e) {
    console.error(e);
    status.textContent = 'Failed ❌';
    alert(e.message || e);
  }
};

function putWithProgress(url, file, contentType) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', url, true);
    xhr.setRequestHeader('Content-Type', contentType || 'application/octet-stream');
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        bar.value = Math.round((e.loaded / e.total) * 100);
      }
    };
    xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(new Error('S3 responded ' + xhr.status));
    xhr.onerror = () => reject(new Error('Network error'));
    xhr.send(file);
  });
}
</script>
</body>
</html>
